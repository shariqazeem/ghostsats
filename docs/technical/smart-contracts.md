# Smart Contracts

All contracts are written in Cairo 2.15 and deployed on Starknet Sepolia.

## ShieldedPool

The core protocol contract. Manages deposits, batch execution, and withdrawals.

### Interface

```cairo
#[starknet::interface]
trait IShieldedPool<TContractState> {
    // ========================================
    // Core Protocol
    // ========================================

    /// Deposit USDC with a Pedersen commitment. Fixed denominations only.
    fn deposit(
        ref self: TContractState,
        commitment: felt252,
        denomination: u8,
        btc_identity_hash: felt252,
    );

    /// Privacy-preserving deposit with ZK commitment
    fn deposit_private(
        ref self: TContractState,
        commitment: felt252,
        denomination: u8,
        btc_identity_hash: felt252,
        zk_commitment: felt252,
    );

    /// Execute the current batch: swap pooled USDC → WBTC via Avnu
    fn execute_batch(
        ref self: TContractState,
        min_wbtc_out: u256,
        routes: Array<Route>,
    );

    /// Withdraw with ZK proof — verified on-chain by Garaga
    fn withdraw_private(
        ref self: TContractState,
        denomination: u8,
        zk_nullifier: felt252,
        zk_commitment: felt252,
        proof: Array<felt252>,      // ~2835 elements
        merkle_path: Array<felt252>, // 20 elements
        merkle_indices: u32,
        recipient: ContractAddress,
        batch_id: u32,
    );

    /// Gasless withdrawal via relayer
    fn withdraw_private_via_relayer(
        ref self: TContractState,
        denomination: u8,
        zk_nullifier: felt252,
        zk_commitment: felt252,
        proof: Array<felt252>,
        merkle_path: Array<felt252>,
        merkle_indices: u32,
        recipient: ContractAddress,
        batch_id: u32,
        relayer: ContractAddress,
        fee_bps: u16,
    );

    // ========================================
    // Compliance
    // ========================================

    /// Register a view key for a commitment
    fn register_view_key(
        ref self: TContractState,
        commitment: felt252,
        view_key_hash: felt252,
    );

    // ========================================
    // View Functions
    // ========================================

    fn get_pending_usdc(self: @TContractState) -> u256;
    fn get_batch_count(self: @TContractState) -> u32;
    fn get_total_volume(self: @TContractState) -> u256;
    fn get_total_batches_executed(self: @TContractState) -> u32;
    fn get_leaf_count(self: @TContractState) -> u32;
    fn get_merkle_root(self: @TContractState) -> felt252;
    fn get_anonymity_set(self: @TContractState, denomination: u8) -> u32;
    fn get_btc_linked_count(self: @TContractState) -> u32;
}
```

### Denominations

| ID | Amount | USDC (6 decimals) |
|----|--------|-------------------|
| 0 | 100 USDC | 100,000,000 |
| 1 | 1,000 USDC | 1,000,000,000 |
| 2 | 10,000 USDC | 10,000,000,000 |

### Merkle Tree

- 20 levels deep → supports 2^20 (1,048,576) commitments
- Pedersen hash at each node
- Pre-computed zero hashes for empty subtrees
- Merkle path = 20 sibling hashes + index bits

### Nullifier Set

When a withdrawal is processed:
1. Compute nullifier from the ZK proof
2. Check nullifier not in `spent_nullifiers` mapping
3. Store nullifier → prevents double-spend

### Exchange Rates

After batch execution:
```
exchange_rate = total_wbtc_received / total_usdc_in_batch
wbtc_share = (deposit_usdc * exchange_rate)
```

### Relayer Fees

```
fee = (wbtc_share * fee_bps) / 10000
recipient_gets = wbtc_share - fee
relayer_gets = fee
```

Maximum fee: 500 bps (5%). Default: 200 bps (2%).

## GaragaVerifier

Generated by the Garaga CLI from the Noir circuit's verification key.

```cairo
#[starknet::interface]
trait IZKVerifier<TContractState> {
    fn verify_ultra_keccak_zk_honk_proof(
        self: @TContractState,
        full_proof_with_hints: Span<felt252>,
    ) -> Result<Span<u256>, felt252>;
}
```

- **Input**: 2835 felt252 values (proof blob + MSM hints + KZG hints)
- **Output**: `Ok(Span<u256>)` with public inputs on success, `Err(felt252)` on failure
- **Verification key**: Baked into contract constants at generation time
- **No constructor**: Deploy with no arguments

## MockERC20

Standard ERC-20 with a public `mint` function for testing:

```cairo
fn mint(ref self: TContractState, to: ContractAddress, amount: u256);
```

Used for:
- **USDC Mock** — Depositors mint test USDC
- **WBTC Mock** — Minted to MockAvnuRouter to simulate swap output
